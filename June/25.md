## å¼‚æ­¥

### å‰è¨€

Javascriptè¯­è¨€çš„æ‰§è¡ŒçŽ¯å¢ƒæ˜¯"å•çº¿ç¨‹"ã€‚åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­ï¼ŒJS å¼•æ“Žä¼šåˆ›å»ºæ‰§è¡Œä¸Šä¸‹æ–‡æ ˆï¼Œä¹‹åŽæˆ‘ä»¬çš„ä»£ç å°±ä¼šä½œä¸ºæ‰§è¡Œä¸Šä¸‹æ–‡ ( å…¨å±€ã€å‡½æ•°ã€eval ) åƒä¸€ç³»åˆ—ä»»åŠ¡ä¸€æ ·åœ¨æ‰§è¡Œä¸Šä¸‹æ–‡æ ˆä¸­æŒ‰ç…§åŽè¿›å…ˆå‡º ( LIFO ) çš„æ–¹å¼ä¾æ¬¡æ‰§è¡Œã€‚

> åŒæ­¥ï¼š

> å¼‚æ­¥ï¼š

### JavaScriptä¸­å¼‚æ­¥çš„å®žçŽ°

> å›žè°ƒå‡½æ•°(callback)

```js
  ajax(url, () => {
    // .....
    ajax(url, () => {
      
    })
  });
```

ä¼˜ç‚¹ï¼šä¼˜ç‚¹æ˜¯ç®€å•ã€å®¹æ˜“ç†è§£å’Œå®žçŽ°ã€‚
ç¼ºç‚¹ï¼šå®¹æ˜“é€ æˆå›žè°ƒåœ°ç‹±ï¼Œä¸åˆ©äºŽç»´æŠ¤ã€‚å„éƒ¨åˆ†ä¹‹é—´è€¦åˆåº¦å¾ˆé«˜ã€‚

> å¸¸ç”¨å®šæ—¶å™¨å‡½æ•°:setTimeout, setInterval, requestAnimationFrame
> äº‹ä»¶ç›‘å¬: å¸¸ç”¨äºŽDOMçš„äº‹ä»¶ç›‘å¬
> å‘å¸ƒ/è®¢é˜… (è§‚å¯Ÿè€…æ¨¡å¼)
> Promise
> Generatorå‡½æ•°
> asyncå‡½æ•° ï¼ˆè®©å¼‚æ­¥ç¼–ç¨‹ç®€å•ï¼‰

### Promise

[PromiseA+è§„èŒƒ](https://promisesaplus.com/)

#### PromiseA+è§„èŒƒ

> æœ¯è¯­

`promise`: promiseæ˜¯ä¸€ä¸ªæ‹¥æœ‰`then`æ–¹æ³•çš„å¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œå…¶è¡Œä¸ºç¬¦åˆæœ¬è§„èŒƒ
`thenable`: æ˜¯ä¸€ä¸ªå®šä¹‰äº†`then`æ–¹æ³•çš„å¯¹è±¡æˆ–è€…å‡½æ•°
`value`: æŒ‡çš„æ˜¯ä»»ä½•JavaScriptçš„åˆæ³•å€¼(undefined , thenable å’Œ promise)
`exception`: æ˜¯ä½¿ç”¨thorwæŠ›å‡ºçš„ä¸€ä¸ªå¼‚å¸¸å€¼
`reason`ï¼špromiseè¢«æ‹’ç»åŽŸå› çš„å€¼

æ³¨é‡Šï¼šå¦‚æžœä¸€ä¸ªå¯¹è±¡å®žçŽ°äº†`then`æ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç§°ä¹‹ä¸ºè¿™ä¸ªå¯¹è±¡æ˜¯`thenable`å¯¹è±¡ã€‚å¯¹æ‰€æœ‰çš„`Promise`éƒ½æ˜¯`thenable`å¯¹è±¡ï¼Œä½†å¹¶éžæ‰€æœ‰çš„`thenable`å¯¹è±¡éƒ½æ˜¯`Promise`ã€‚

> è¦æ±‚
   
1. Promiseçš„çŠ¶æ€

ä¸€ä¸ª`promise`å¿…é¡»å¤„äºŽä¸‰ç§çŠ¶æ€`pending`-ç­‰å¾…,`fulfilled`-å®Œæˆ,`rejected`-æ‹’ç»å…¶ä¸­çš„ä¸€ç§
  a. å½“å¤„äºŽ`pending`çŠ¶æ€ï¼Œå¯èƒ½è½¬æ¢ä¸º`fulfilled`æˆ–è€…`rejected`
  b. å½“å¤„äºŽ`fulfilled`çŠ¶æ€ï¼Œæ— æ³•è½¬å˜ä¸ºä»»ä½•å…¶ä»–çŠ¶æ€ï¼›å¿…é¡»æœ‰ä¸€ä¸ªä¸å¯å˜çš„æœ€ç»ˆå€¼ï¼›
  c. å½“å¤„äºŽ`rejected`çŠ¶æ€ï¼Œæ— æ³•è½¬å˜ä¸ºä»»ä½•å…¶ä»–çŠ¶æ€ï¼›å¿…é¡»æœ‰ä¸€ä¸ªä¸å¯å˜çš„åŽŸå› (å€¼)ï¼›

æ³¨é‡Šï¼šè¿™é‡Œçš„ä¸å¯å˜æŒ‡çš„æ˜¯æ’ç­‰ï¼ˆå³ === ï¼‰ï¼Œè€Œä¸æ˜¯æ„å‘³ç€å…¶å†…éƒ¨çš„ä¸å¯å˜ï¼ˆå³ä»…ä»…æ˜¯å…¶å¼•ç”¨åœ°å€ä¸å˜ï¼Œä½†å±žæ€§å€¼å¯è¢«æ›´æ”¹ï¼‰ã€‚

2. thenæ–¹æ³•

ä¸€ä¸ª`promise`å¿…é¡»æä¾›ä¸€ä¸ª`then`æ–¹æ³•ä»¥è¯»å–å…¶å½“å‰å€¼ã€ç»ˆå€¼å’Œå¤±è´¥åŽŸå› ã€‚
`promise`çš„`then`æ–¹æ³•æŽ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š

2.1 `promise.then(onFulfilled, onRejected)`

  a. `onFulfilled `å’Œ `onRejected` éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚`onFulfilled`å’Œ`onRejected`å¦‚æžœä¸æ˜¯å‡½æ•°ï¼Œå…¶å¿…é¡»è¢«å¿½ç•¥ã€‚
  b. å¦‚æžœ`onFulfilled`æ˜¯å‡½æ•°ï¼Œå®ƒå¿…é¡»åœ¨`promise`çš„çŠ¶æ€å˜ä¸º`fulfilled`ä¹‹åŽè¢«è°ƒç”¨ï¼Œå¹¶ä¸”`promise`çš„å€¼`(value)`ä½œä¸ºå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼›åœ¨`promise`çš„çŠ¶æ€å˜ä¸º`fulfilled`ä¹‹å‰éƒ½ä¸èƒ½è¢«è°ƒç”¨ï¼›ä¸èƒ½è¢«è°ƒç”¨è¶…è¿‡ä¸€æ¬¡ã€‚
  c. å¦‚æžœ`onRejected`æ˜¯å‡½æ•°ï¼Œå®ƒå¿…é¡»åœ¨`promise`çš„çŠ¶æ€å˜æˆ`rejected`ä¹‹åŽæ‰èƒ½è¢«è°ƒç”¨ï¼Œå¹¶ä¸”`promise`çš„åŽŸå› `(reason)`ä½œä¸ºå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼›åœ¨`promise`çŠ¶æ€å˜ä¸º`rejected`ä¹‹å‰éƒ½ä¸èƒ½è¢«è°ƒç”¨;ä¸èƒ½è¢«è°ƒç”¨è¶…è¿‡ä¸€æ¬¡ã€‚

2.2 `onFulfilled`å’Œ`onRejected`åªæœ‰åœ¨æ‰§è¡ŒçŽ¯å¢ƒå †æ ˆä»…åŒ…å«å¹³å°ä»£ç æ—¶æ‰èƒ½è¢«è°ƒç”¨.
2.2 `onFulfilled`å’Œ`onRejected`å¿…é¡»ä½œä¸ºæ™®é€šå‡½æ•°è¢«è°ƒç”¨ã€‚(å³æ²¡æœ‰`this`çš„å€¼).
2.3 åŒä¸€ä¸ª`promise`çš„`then`æ–¹æ³•å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡
```js
var p = new Promise((resolve) => {
  resolve(1);
});
p.then();
p.then();
```

2.4 `then`æ–¹æ³•å¿…é¡»è¿”å›žä¸€ä¸ª`promise`ï¼š
`promise2 = promise1.then(onFulfilled, onRejected);`

2.4.1 å¦‚æžœ`onFulfilled`æˆ–è€…`onRejected`è¿”å›žçš„æ˜¯ä¸€ä¸ªå€¼`x`,åˆ™å¿…é¡»æ‰§è¡Œ**Promiseè§£æžç¨‹åº**`[[Resolve]](promise2, x)`
2.4.2 å¦‚æžœ`onFulfilled`æˆ–è€…`onRejected`æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸`e`ï¼Œåˆ™`promise2`å¿…é¡»è¢«æ‹’ç»`rejected`,å¹¶ä¸”å°†`e`ä½œä¸ºæ‹’ç»åŽŸå› (reason)

```js
var p = new Promise((resolve, reject) => {
  resolve(1);
})
p.then(() => {
    throw new Error ('error');
  })
  .then(
    value => {
      console.log('then-funfilled-1',value);
    },
    reason => {
      console.log('then-rejected-1',reason);
    }
  ).then(
    value => {
      console.log('then-funfilled-2',value);
    },
    reason => {
      console.log('then-rejected-2',reason);
    }
  );
```

2.4.3 å¦‚æžœ`onFulfilled`ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”`promise1`å·²ç»å˜æˆ`fulfilled`çŠ¶æ€ï¼Œ`promise2`å¿…é¡»æˆåŠŸæ‰§è¡Œä¸Ž`promise1`ç›¸åŒçš„å€¼ã€‚

```js
var p = new Promise((resolve, reject) => {
  resolve(1);
})
p.then()
.then(value => {
  console.log(value);
});
```

2.4.4 å¦‚æžœ`onRejected`ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”`promise1`å·²ç»å˜æˆ`rejected`çŠ¶æ€,`promise2` å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›žç›¸åŒçš„æ®å› .

```js
const p = new Promise((resolve, reject) => {
  resolve(1);
});
p.then(() => {
  throw new Error ('error');;
})
.then()
.then(value => {
  console.log(value); // ä¸ä¼šæ‰§è¡Œ
},() => {
  console.log('error'); // error
});
```

thenæ€»ç»“ï¼š

1. `then`çš„å‚æ•°`onFulfilled`å’Œ`onRejected`å¯ä»¥çœç•¥ï¼Œå¦‚æžœ`onFulfilled`æˆ–è€…`onRejected`ä¸æ˜¯å‡½æ•°ï¼Œå°†å…¶ä¼šç•¥ï¼Œåœ¨åŽé¢çš„`then`ä¸­èŽ·å–åˆ°ä¹‹å‰è¿”å›žçš„å€¼
2. `promise`å¯ä»¥æ‰§è¡Œå¤šæ¬¡`then`ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œ`promise.then`æ–¹æ³•ä¹‹åŽéƒ½è¿”å›žä¸€ä¸ªæ–°çš„`promise`
3. å¦‚æžœ`then`çš„è¿”å›žå€¼`x`æ˜¯ä¸€ä¸ªæ™®é€šå€¼ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªç»“æžœä½œä¸ºå‚æ•°ä¼ é€’åˆ°ä¸‹ä¸€ä¸ª`then`çš„æˆåŠŸå›žè°ƒå‡½æ•°ä¸­
4. å¦‚æžœ`then`ä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£å™©æ¢¦å°±ä¼šæŠŠè¿™ä¸ªå¼‚å¸¸ä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™ä¸‹ä¸€ä¸ª`then`çš„å¤±è´¥çš„å›žè°ƒä¸­
5. å¦‚æžœ`then`çš„è¿”å›žå€¼`x`æ˜¯ä¸€ä¸ª`promise`ï¼Œé‚£ä¹ˆä¼šç­‰è¿™ä¸ª`promise`æ‰§è¡Œå®Œï¼Œ`promise`å¦‚æžœæˆåŠŸï¼Œå°±èµ°ä¸‹ä¸€ä¸ª`then`çš„æˆåŠŸï¼›å¦‚æžœå¤±è´¥ï¼Œå°±èµ°ä¸‹ä¸€ä¸ª`then`çš„å¤±è´¥ï¼›å¦‚æžœæŠ›å‡ºå¼‚å¸¸ï¼Œå°±èµ°ä¸‹ä¸€ä¸ª`then`çš„å¤±è´¥ï¼›
6. å¦‚æžœ`then`çš„è¿”å›žå€¼`x`å’Œ`promise`æ˜¯åŒä¸€ä¸ªå¼•ç”¨å¯¹è±¡ï¼Œé€ æˆå¾ªçŽ¯å¼•ç”¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼ŒæŠŠå¼‚å¸¸ä¼ é€’ç»™ä¸‹ä¸€ä¸ª`then`çš„å¤±è´¥å›žè°ƒä¸­ï¼›
7. å¦‚æžœ`then`çš„è¿”å›žå€¼`x`æ˜¯ä¸€ä¸ª`promise`ï¼Œä¸”`x`åŒæ—¶è°ƒç”¨äº†`resolve`å‡½æ•°å’Œ`reject`å‡½æ•°ï¼Œåˆ™ç¬¬ä¸€æ¬¡è°ƒç”¨ä¼˜å…ˆï¼Œå…¶ä»–è°ƒç”¨è¢«å¿½ç•¥


8. Promiseè§£æžç¨‹åº

`Promise`è§£æžç¨‹åºæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ“ä½œï¼Œå…¶éœ€è¦è¾“å…¥ä¸€ä¸ª`promise`å’Œä¸€ä¸ªå€¼ã€‚è¡¨ç¤ºä¸º`[[Resolve]](promise, x)`ã€‚

3.1 å¦‚æžœpromiseå’ŒxæŒ‡å‘åŒä¸€å¯¹è±¡ï¼Œé‚£ä¹ˆç”¨TypeErrorä½œä¸ºåŽŸå› æ‹’ç»promiseã€‚
3.2 å¦‚æžœxæ˜¯ä¸€ä¸ªpromiseï¼Œåˆ™ä½¿ç”¨å®ƒçš„çŠ¶æ€ï¼š
    a. å¦‚æžœxæ˜¯pendingï¼Œåˆ™promiseå¿…é¡»ä¿ç•™pendingç›´åˆ°xå˜ä¸ºfulfilledæˆ–rejected
    b. å¦‚æžœ(å½“)xæ˜¯fulfilledï¼Œä½¿ç”¨ç›¸åŒçš„å€¼å±¥è¡Œpromise
    c. å¦‚æžœ(å½“)xæ˜¯rejectedï¼Œä½¿ç”¨ç›¸åŒçš„åŽŸå› æ‹’ç»promise
3.3 å¦‚æžœxæ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è€…æ–¹æ³•
    a. è®©xä½œä¸º`x.then`
    b. å¦‚æžœ`x.then`çš„ç»“æžœæ˜¯ä¸€ä¸ªå¼‚å¸¸`e`,ç”¨`e`ä½œä¸ºåŽŸå› 
    c. å¦‚æžœ`then`æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼ŒæŠŠ`x`å½“ä½œ`this`æ¥è°ƒç”¨
3.4 å¦‚æžœxæ—¢ä¸æ˜¯å¯¹è±¡ä¹Ÿä¸æ˜¯å‡½æ•°ï¼Œåˆ™xå®Œæˆ`fulfilled`


### éžPromiseçš„thenableå¯¹è±¡

### å‚è€ƒé“¾æŽ¥

0. https://juejin.cn/post/6844903625769091079
1. https://juejin.cn/post/6844903512845860872
2. https://github.com/ljianshu/Blog/issues/53
3. https://zhuanlan.zhihu.com/p/62403414
4. https://github.com/YvetteLau/Blog/issues/2
   

### ä¾‹å­ðŸŒ°

> è¿”å›žä¸€ä¸ªPromise

```js
const p1 = new Promise((resolve, rejected) => {
  resolve(42);
});

const p2 = new Promise((resolve, rejected) => {
  resolve(43);
});

// onFulfilledè¿”å›žä¸€ä¸ªpromise
p1.then(value => {
  console.log(value); // 42
  return p2;
}).then(value => {
  console.log(value); // 43
});
```

> å¾ªçŽ¯å¼•ç”¨

```js
const p1 = new Promise(resolve => {
  resolve(2);
});

const p2 = p1.then(() => {
  return p2; // æŠ¥TypeErrorçš„é”™è¯¯ï¼šChaining cycle detected for promise
});
```

> æ™®é€šé“¾å¼è°ƒç”¨

```js
const p1 = new Promise(resolve => {
  resolve(2);
});

p1.then(value => {
  console.log('then 1:', value); // 2
  return value + 1;
}).then(value => {
  console.log('then 2:', value); // 3
});

// onFulfilledæ²¡æœ‰è¿”å›žå€¼
p1.then(value => {
  console.log('then 3:', value); // 2
}).then(value => {
  console.log('then 4:', value); // undefined
});

p1.then().then(value => {
  console.log('then 5:', value); // 2
});
```
// Chromeæ‰“å°ç»“æžœ

![image](https://user-images.githubusercontent.com/25894364/124214246-8022c500-db24-11eb-9f60-ce447dc5b84e.png)


> å…¶ä»–æƒ…å†µ

```js
// ä¾‹1
Promise.resolve(2)
  .then(3)
  .then(Promise.resolve(4))
  .then(value => console.log(value)); // 2

// ä¾‹2
Promise.resolve(2)
  .then(() => {
    return 3;
  })
  .then(Promise.resolve(4))
  .then(value => console.log(value)); // 3
```
